$(document).ready(function () {   

    //timer();

    $(function () {
        if ($('input[name="phone"]').length > 0) {
          $('input[name="phone"]').mask('+7(999)999-99-999');
        }


    });    

    //Отправка формы
    $('.bg_flyform form').on('submit', function () {
        $form = $(this);

        var answer = checkForm($form.get(0));
        if (answer != false) {
            var phone = $('input[name="phone"]', $form).val();
            phone = phone.replace(/[^0-9]/gim, '');
			if (phone.length == '11') {phone = phone.substring(1); }
			if (phone.length == '12') {phone = phone.substring(1);phone = phone.substring(1);}
            phone = '+7' + phone;
			
			if (phone!='' && phone!=undefined && phone!='+7 (___) ___-____') {
		    phone_ct = phone.replace(/[^0-9]/gim, '');
		    if (phone_ct!=''&&phone_ct!=undefined){
			if (phone_ct[0] == '7') {phone_ct=phone_ct.substring(1);}
			if (phone_ct[0] == '8') {phone_ct=phone_ct.substring(1);}
			phone_ct= '+7' +phone_ct;
			var ct_clb = 'Скрипт колбека еще не вызван';
			var ct_status = 'Статус не определен';
			if (typeof(window['ctCheckCallbackShouldBeProcessed']) == 'function') {
				ct_clb = 'Колбек активен, но не отправлен';
				if (ctCheckCallbackShouldBeProcessed()) { // Проверяем следует ли отправлять заявку на обратный звонок
					ct_status = ctSendCallbackRequest(phone_ct);
					ct_clb = 'Колбек отправлен';
				}
			} else {
		    	ct_clb = 'Скрипт колбека не инициализирован';
			}	
		}	
	    var ct_log = ct_clb + ', ' + ct_status + ', ' + window.location.href;	
try { CBHCore.api.sendCall({phone: phone, call_asap: 1}); } catch (e) { CBHCore.helpers.logError('CATCH JS ERROR: ' + e.name + '; ' + e.message); }
		}

            var fd = new FormData();
            var target = $('input[name="target"]').val();
            yaCounter41745614.reachGoal('lead');           

            fd.append('phone', phone);
            fd.append('name', $('input[name="name"]', $form).val());
            fd.append('formname', $('input[name="formname"]').val());
            fd.append('car', $('input[name="car"]').val());
            fd.append('call_value', window.call_value);
		    fd.append('ct_log', ct_log);
			fd.append('client_id', $('.client_id').val());
			
			
			

			
    $('.bg_flyform').hide();
    $('.bg_flyform.blago').animate({opacity: 'show'}, "fast");
            
            $.ajax({
                type: "POST",
                url: "send.php",
                data: fd,
                processData: false,
                contentType: false,
                dataType: "json",
                complete: function (msg) {                    
                    thx(target);
                    console.log(msg);
                }

            });
        }
        return false;
    });


    //Всплывающие формы
    $('.bg_flyform .close').click(function () {
        $('.bg_flyform').animate({opacity: 'hide'}, "fast");
    });

});


function thx(target) {
    $('input[name="phone"]').val('');
    $('input[name="name"]').val('');
	yaCounter41745614.reachGoal('final_lead');    


}



function cels(cel) {
    $('input[name="target"]').val('final_lead');
}



function checkForm(form1) {

    var $form = $(form1);
    var checker = true;

    var phone = $("input[name='phone']", $form).val();

    if (!phone || /[^0-9\+ ()\-]/.test(phone)) {
        $form.find("input[name='phone']").addClass("redput");
        checker = false;
    } else {
        $form.find("input[name='phone']").removeClass("redput");
    }

	
	phone = phone.replace(/[^0-9]/gim, '');
	if (phone.length < '11') {
	$form.find("input[name='phone']").addClass("redput");
	checker = false;
	} else {
	$form.find("input[name='phone']").removeClass("redput");
	} 		

    if (checker != true) {
        return false;
    }
}

$(document).ready(function(){
    
    $(".btn-menu").on('click', function(){
        $(".block-fly-menu").animate({"left":"-20px", "opacity": "1"}, "slow");
    });
    
    $(".menu-close").on('click', function(){
        $(".block-fly-menu").animate({"left":"-340px", "opacity": "0"}, "slow");
    });
    
    $(".fly-menu-list > li > a").on('click', function(){
        $(".block-fly-menu").animate({"left":"-340px", "opacity": "0"}, "slow");
    });
    
    function setEqualHeight(columns)
    {
        var tallestcolumn = 0;
        columns.each(
            function()
            {
                currentHeight = $(this).height();
                if(currentHeight > tallestcolumn)
                {
                    tallestcolumn = currentHeight;
                }
            }
        );
        columns.height(tallestcolumn);
    }

    $(window).load(function() {
        
        setEqualHeight($(".block-fly-btn > div"));
      
    });
    
     $(window).resize(function() {
        setEqualHeight($(".block-fly-btn > div"));
     });
    
});